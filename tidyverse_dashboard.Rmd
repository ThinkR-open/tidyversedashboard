---
title: "Tidyverse repository dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
params:
  start: 
    label: Start date of report
    value: !r lubridate::today() - lubridate::ddays(30)
    input: date
  orgs:
    label: GitHub organizations
    value: tidyverse, r-lib, r-dbi
    input: text
---

```{r setup, include = FALSE}
library(flexdashboard)
library(gh)
library(jsonlite)
library(lubridate)
library(dplyr)
library(purrr)
library(tibble)
library(codetools) # there was a weird error on connect that needed this
library(DT)
library(tidyversedashboard)
library(tidyr)
library(sparkline)
library(ggplot2)
on_macos <- tolower(Sys.info()[["sysname"]]) == "darwin"
gh_colors <- list(
  green = "#2cbe4e",
  red = "#CB2434",
  purple = "#6f42c1")
start <- params$start
duration <- format(today() - start, format = "%d")
orgs <- scan(text = params$orgs, what = "character", sep = ",", strip.white = TRUE, quiet = TRUE)
```

```{r pr_stats, include=FALSE, cache = on_macos}
options(repos = c(CRAN='https://cloud.r-project.org'))

pr_data <- tryCatch(
  map_dfr(orgs, org_pr),
  error = function(e) message(e$content$errors))

if (!is.null(pr_data)) {
prs <- pr_data %>% filter(updated >= start) %>%
  mutate(reviewer = map2(reviews, comments, function(reviews, comments) unique(c(reviews$reviewer, comments$commenter)))) %>%
  select(owner, repo, number, author, created, updated, reviewer) %>% 
  unnest() %>%
  filter(reviewer != author)

pr_authors <- prs %>% group_by(author) %>% select(-reviewer) %>% unique() %>% tally(sort = TRUE)
pr_reviewers <- prs %>% group_by(reviewer) %>% select(-author) %>% unique() %>% tally(sort = TRUE)
pr_pairs <- prs %>% group_by(author, reviewer) %>% tally(sort = TRUE)
} else {
  pr_authors <- NULL
  pr_reviewers <- NULL
  pr_pairs <- NULL
}
```

```{r repo_stats, include = FALSE, cache = on_macos}
issue_data <- map(orgs, org_data)

repo_summary <- map_dfr(issue_data, "summary")
issues <- map_dfr(issue_data, "issues")
```


`r duration` issue progress
=====================================
```{r issue_progress, cache = on_macos, include = FALSE}
issue_data <- map_dfr(orgs, issue_progress, start)

issue_data2 <- issue_data %>% 
  mutate(
    type = factor(levels = c("issue", "pull_request"),
      case_when(
        type == "Issue" ~ "issue",
        type == "PullRequest" ~ "pull_request")),

    status = factor(levels = c("opened", "closed", "merged"),
      case_when(
        merged >= start ~ "merged",
        closed >= start ~ "closed",
        opened >= start ~ "opened",
        TRUE ~ NA_character_)),
    event = case_when(
      status == "merged" ~ merged,
      status == "closed" ~ closed,
      status == "opened" ~ opened)
  )
```

````{r}
totals <- issue_data2 %>% group_by(type, status) %>% tally() %>% mutate(n = if_else(status == "closed" | status == "merged", n * -1L, n)) %>% na.omit()
```

Row
------------------------------

### Issues / pull requests opened
```{r}
valueBox(totals %>% filter(status == "opened") %>% pull("n") %>% sum(), icon = "fa-exclamation-circle", color = gh_colors$green)
```

### Issues closed
```{r}
valueBox(totals %>% filter(type == "issue", status == "closed") %>% pull("n"), icon = "fa-times-circle", color = gh_colors$red)
```

### Pull requests merged / closed
```{r}
valueBox(totals %>% filter(type == "pull_request" & (status == "merged" | status == "closed")) %>% pull("n") %>% sum(), icon = "ion-merge", color = gh_colors$purple)
```

### `r duration` change

```{r}
valueBox(sum(totals$n), icon = "fa-exclamation-circle", color = "blue")
```

Row
-------------------------------------

### `r duration` progess

```{r}
issue_progress_table <- issue_data2 %>%
  # Add maintiner to the table
    left_join(mutate(repo_summary, maintainer = as.factor(desc_maintainer(description))) %>% 
              select(repo, maintainer), by = c("package" = "repo")) %>%
  group_by(type, status) %>%
  arrange(event) %>%
  mutate(number = glue::glue('<a href="https://github.com/{owner}/{package}/issues/{number}">{number}</a>')) %>%
  select(owner, package, number, maintainer, event, status, type) %>%
  na.omit()

data_table(issue_progress_table, escape = FALSE)
```

> Issues with status modified (`r start` - `r now()`).

### Issue status

```{r}

# ggplot(res, aes(event, count, color = status, linetype = type)) +
#   geom_line() +
#   # These are the colors used for these states on GitHub
#   scale_color_manual(values = c(opened = gh_colors$green, closed = gh_colors$red, merged = gh_colors$purple))

issue_progress_running <-
  issue_progress_table %>% group_by(type) %>% mutate(count = case_when(
    type == "issue" & status == "closed" ~ -1,
    type == "pull_request" &
      (status == "merged" | status == "closed") ~ -1,
    TRUE ~ 1
  )) %>% mutate(running_total = cumsum(count))

ggplot(issue_progress_running, aes(event, running_total, linetype = type)) +
  geom_step() + labs(x = NULL, y = "Open Issues")
```

> `r start` - `r now()`

Repository statistics
=====================================

```{r repo_summary, cache = on_macos}
summary_table <- repo_summary %>%
  rename("\U1F44D" = p1, "package" = "repo") %>%
  mutate(
    weekly_downloads = num_downloads(.$package, "last-week"),
    maintainer = as.factor(desc_maintainer(description)),
    reverse_deps = reverse_dependencies(package),
    dev_deps = desc_dev_deps(description),
    travis_status = glue::glue('<a href="https://travis-ci.org/{owner}/{package}"><img src="https://travis-ci.org/{owner}/{package}.svg?branch=master"></a>'),
    appveyor_status = glue::glue('<a href="https://ci.appveyor.com/api/projects/status/github/{owner}/{package}"><img src="https://ci.appveyor.com/api/projects/status/github/{owner}/{package}?svg=true&branch=master"></a>'),
    activity = map2(owner, package, weekly_commits)) %>%
  select(owner, package, maintainer, watchers, reverse_deps, weekly_downloads, open_issues, prs, "\U1F44D", everything(), -description)
```

```{r}
# A custom datatable with a sparkline column
dt <- data_table(summary_table, escape = FALSE,
  colnames = c("52 week commit activity" = "activity"),
  options = list(
    columnDefs = list(
      list(targets = "_all", orderSequence = c("desc", "asc")),
      list(
        targets = which(colnames(summary_table) == "activity") - 1,
        render = JS("
          function(data, type, row, meta) {
            return '<span class=spark>' + data + '</span>'
          }"))),
    fnDrawCallback = JS("
      function (oSettings, json) { $('.spark:not(:has(canvas))').sparkline('html', {width: '100px', lineColor: '#DCAB49', fillColor: '#DBDED3', spotColor: '', minSpotColor: '', maxSpotColor: ''}) }")))
dt$dependencies <- append(dt$dependencies, htmlwidgets::getDependency("sparkline"))
dt
```

Open issues
=====================================
```{r issue_summary}
substitute_emoji <- function(x) {
  m <- gregexpr(":[^[:space:]]+:", x)

  regmatches(x, m) <- lapply(regmatches(x, m), function(xx) map_chr(gsub(":", "", xx), emo::ji))
  x
}

# linkify the titles, and replace emoji
issue_table <- mutate(issues,
  title = glue::glue('<a href="https://github.com/{owner}/{repo}/issues/{issue}">{title}</a>'),
  labels = substitute_emoji(map_chr(labels, paste, collapse = ", "))) %>%
  rename("\U1F44D" = p1)

data_table(issue_table, escape = -4)
```

Pull request review counts
=====================================


### PR authors
```{r}
data_table(pr_authors)
```

### PR reviewers
```{r}
data_table(pr_reviewers)
```

### PR pairs
```{r}
data_table(pr_pairs)
```
